# KCL Crossplane Claim Modules

Guide for converting Crossplane CompositeResourceDefinitions (XRDs) to KCL modules.

## Overview

This document covers the transition from a Crossplane XRD definition to a fully functional KCL module with:

1. KCL schema (type-safe resource definitions)
2. main.k (parameterized templates)
3. ClaimTemplate YAML (UI/CLI metadata)

## Directory Structure

```
claim-xplane-<resource>/
├── kcl.mod                    # Module configuration
├── main.k                     # Entry point with templates
├── README.md                  # Usage documentation
├── k8s/                       # Kubernetes metadata schemas
│   └── apimachinery/pkg/apis/meta/v1/
│       ├── managed_fields_entry.k
│       ├── object_meta.k
│       └── owner_reference.k
├── v1alpha1/                  # Resource schemas
│   └── resources_stuttgart_things_com_v1alpha1_<resource>.k
├── examples/                  # Usage examples
│   └── simple-<resource>.k
└── templates/                 # ClaimTemplate definitions
    └── <resource>-simple.yaml
```

## Step 1: Convert XRD to KCL Schema

### Source: Crossplane XRD Definition

```yaml
apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: vspherevms.resources.stuttgart-things.com
spec:
  group: resources.stuttgart-things.com
  names:
    kind: VsphereVM
    plural: vspherevms
  versions:
    - name: v1alpha1
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                vm:
                  type: object
                  properties:
                    name:
                      type: string
                    ram:
                      type: string
                      default: "4096"
                  required:
                    - name
```

### Target: KCL Schema

Create `v1alpha1/resources_stuttgart_things_com_v1alpha1_<resource>.k`:

```python
"""
This file was generated by the KCL auto-gen tool. DO NOT EDIT.
"""
import ..k8s.apimachinery.pkg.apis.meta.v1

schema VsphereVM:
    r"""
    VsphereVM is a composite resource for managing vSphere VMs

    Attributes
    ----------
    apiVersion : str, default is "resources.stuttgart-things.com/v1alpha1", required
    kind : str, default is "VsphereVM", required
    metadata : v1.ObjectMeta, default is Undefined, optional
    spec : ResourcesStuttgartThingsComV1alpha1VsphereVMSpec, required
    status : ResourcesStuttgartThingsComV1alpha1VsphereVMStatus, optional
    """

    apiVersion: "resources.stuttgart-things.com/v1alpha1" = "resources.stuttgart-things.com/v1alpha1"
    kind: "VsphereVM" = "VsphereVM"
    metadata?: v1.ObjectMeta
    spec: ResourcesStuttgartThingsComV1alpha1VsphereVMSpec
    status?: ResourcesStuttgartThingsComV1alpha1VsphereVMStatus


schema ResourcesStuttgartThingsComV1alpha1VsphereVMSpec:
    r"""Spec schema"""
    vm: ResourcesStuttgartThingsComV1alpha1VsphereVMSpecVm
    # ... other required fields


schema ResourcesStuttgartThingsComV1alpha1VsphereVMSpecVm:
    r"""VM configuration"""
    name: str                      # required field (no ?)
    ram: str = "4096"              # optional with default
    optionalField?: str            # optional without default
```

### Conversion Rules

| OpenAPI Schema | KCL Schema |
|----------------|------------|
| `type: string` | `str` |
| `type: integer` | `int` |
| `type: boolean` | `bool` |
| `type: object` | nested schema |
| `type: array` | `[ElementType]` |
| `required: [field]` | `field: Type` (no `?`) |
| not in required | `field?: Type` (with `?`) |
| `default: "value"` | `field: str = "value"` |
| `enum: [a, b]` | `field: "a" \| "b"` |

## Step 2: Create main.k with Templates

The main.k provides parameterized templates for common use cases.

### Structure

```python
"""
Example usage of <Resource> in KCL.
With conditional template loading based on template name.
"""

import k8s.apimachinery.pkg.apis.meta.v1 as v1
import v1alpha1.resources_stuttgart_things_com_v1alpha1_<resource> as resourcemod

# Read parameters from CLI or fallback to defaults
_params = option("params") or {}
_spec = _params?.resource?.spec or {}

# Template selector
_templateName = option("templateName") or _params?.templateName or "demo"

# Parameters with type conversion for numeric values
_name = option("name") or "demo-resource"
_numericParam = str(option("numericParam") or "default")  # Convert to string if schema expects string

# Demo Template
if _templateName == "demo":
    resourcemod.Resource {
        metadata = v1.ObjectMeta {
            name = _name
            namespace = _namespace
        }
        spec = resourcemod.ResourceSpec {
            # ... fields
        }
    }

# Production Template
if _templateName == "production":
    resourcemod.Resource {
        # ... production configuration
    }

# Minimal Template
if _templateName == "minimal":
    resourcemod.Resource {
        # ... minimal required fields only
    }
```

### Key Patterns

1. **Type Conversion**: CLI passes integers, but schema may expect strings:
   ```python
   _ram = str(_vmSpec?.ram or option("ram") or "4096")
   ```

2. **Optional Chaining**: Safe access to nested params:
   ```python
   _vmSpec = _spec?.vm or {}
   _name = _vmSpec?.name or option("name") or "default"
   ```

3. **Template Selection**: Conditional resource creation:
   ```python
   if _templateName == "demo":
       # create demo resource
   ```

4. **Import Alias**: Avoid naming conflicts with field names:
   ```python
   # BAD: field 'vm' conflicts with import alias
   import ... as vm
   spec.vm = vm.VmSpec {}

   # GOOD: use distinct alias
   import ... as vspherevm
   spec.vm = vspherevm.VsphereVMSpecVm {}
   ```

## Step 3: Create ClaimTemplate YAML

The template file provides metadata for UI/CLI tools.

### Location

`templates/<resource>-simple.yaml`

### Structure

```yaml
---
apiVersion: resources.stuttgart-things.com/v1alpha1
kind: ClaimTemplate
metadata:
  name: <resource>
  title: Crossplane <Resource Title>
  description: Creates a <resource> via Crossplane
  tags:
    - crossplane
    - terraform
spec:
  type: <resource>
  source: oci://ghcr.io/stuttgart-things/claim-xplane-<resource>
  tag: 0.1.0
  parameters:
    # Template selector
    - name: templateName
      title: Template
      type: string
      default: demo
      enum:
        - demo
        - production
        - minimal
      description: "Template type description"

    # Required string parameter
    - name: name
      title: Resource Name
      type: string
      required: true
      default: demo-resource
      pattern: "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$"
      description: "Name of the resource"

    # Integer parameter
    - name: count
      title: Count
      type: integer
      default: 1
      description: "Number of resources"

    # Boolean parameter
    - name: enabled
      title: Enabled
      type: boolean
      default: true
      description: "Enable feature"

    # Enum parameter
    - name: type
      title: Type
      type: string
      default: standard
      enum:
        - standard
        - premium
      description: "Resource type"
```

### Parameter Types

| Type | YAML | Description |
|------|------|-------------|
| String | `type: string` | Text value |
| Integer | `type: integer` | Numeric value |
| Boolean | `type: boolean` | true/false |
| Enum | `type: string` + `enum: [...]` | Constrained choices |

### Validation

| Field | Description |
|-------|-------------|
| `required: true` | Parameter must be provided |
| `default: value` | Default if not provided |
| `pattern: regex` | Regex validation for strings |
| `enum: [a, b]` | Allowed values |

## Step 4: Update kcl.mod

```toml
[package]
name = "claim-xplane-<resource>"
edition = "v0.11.2"
version = "0.1.0"

[profile]
entries = [
    "main.k"
]
```

## Step 5: Create README.md

```markdown
# CLAIM-XPLANE-<RESOURCE>

KCL schema for creating <resource> via Crossplane.

## Templates

| Template | Description |
|----------|-------------|
| `demo` | Basic configuration for testing |
| `production` | Production-ready configuration |
| `minimal` | Bare minimum required fields |

## Usage

### Demo Template (default)

\`\`\`bash
kcl run main.k
\`\`\`

### Custom Parameters

\`\`\`bash
kcl run main.k -D name=my-resource -D param=value
\`\`\`

### Using OCI Registry

\`\`\`bash
kcl run oci://ghcr.io/stuttgart-things/claim-xplane-<resource> --tag 0.1.0 -D name=my-resource
\`\`\`

## Available Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `name` | Resource name | `demo` |
| ... | ... | ... |
```

## Validation

Test the module:

```bash
# Compile check
cd claim-xplane-<resource>
kcl run main.k

# Test templates
kcl run main.k -D templateName=demo
kcl run main.k -D templateName=production
kcl run main.k -D templateName=minimal

# Test parameters
kcl run main.k -D name=test -D param=value
```

## Example: VsphereVM Module

Reference implementation: `claim-xplane-vspherevm/`

```bash
# Demo template
kcl run main.k

# Production with custom name
kcl run main.k -D templateName=production -D name=prod-server

# Custom parameters (integers auto-converted to strings)
kcl run main.k -D name=my-vm -D ram=8192 -D cpu=8 -D datacenter=MyDC
```
